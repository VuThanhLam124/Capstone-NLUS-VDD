# BUSINESS RULES FOR TPC-DS TEXT-TO-SQL
# Admin co the update file nay. Noi dung se duoc chen vao system prompt.

=== CRITICAL RULES ===
1. KHONG them filter (WHERE) neu cau hoi KHONG yeu cau (vi du: khong them d.d_year neu khong hoi ve nam)
2. "ban chay nhat" = SUM(quantity), KHONG phai SUM(sales_price)
3. "tra lai hang" (khong ro channel) -> mac dinh dung store_returns (sr)
4. "tu X tro len" = >= X (vi du: "tu 2 xe tro len" = hd_vehicle_count >= 2)
5. Chi SELECT cac columns can thiet, khong them columns thua
6. KHONG bia cot/bang khong co trong schema
7. Luon dung table aliases
8. Output ONLY the SQL query, no explanation.

=== COLUMN & TABLE MAPPINGS ===
CUSTOMER (c):
- c.c_salutation: danh xung (Mr., Ms., Mrs., Dr.)
- c.c_birth_day / c.c_birth_month / c.c_birth_year: ngay/thang/nam sinh (KHONG join date_dim)
- c.c_birth_country: quoc gia sinh / quoc tich
- c.c_preferred_cust_flag: khach hang uu tien (Y/N)
- c.c_login, c.c_email_address

CUSTOMER_DEMOGRAPHICS (cd):
- cd.cd_gender, cd.cd_marital_status, cd.cd_credit_rating
- cd.cd_education_status, cd.cd_dep_count, cd.cd_dep_college_count

HOUSEHOLD_DEMOGRAPHICS (hd):
- hd.hd_vehicle_count, hd.hd_dep_count, hd.hd_income_band_sk

CUSTOMER_ADDRESS (ca):
- ca.ca_state, ca.ca_city, ca.ca_country (dia chi hien tai)

ITEM (i):
- "ten san pham" -> i.i_product_name
- "mo ta san pham" -> i.i_item_desc
- "gia niem yet / gia hien tai" -> i.i_current_price (KHONG co i_list_price)
- Danh muc lon -> i.i_category, Loai cu the -> i.i_class
- "vay" -> i.i_class = 'dresses'
- "ao so mi" -> i.i_class = 'shirts'
- "ao kieu" -> i.i_class = 'blouses'
- "quan" -> i.i_class = 'pants'
- "quan jeans" -> i.i_class = 'jeans'

CATALOG PAGE:
- "trang so X trong catalog" -> JOIN catalog_page cp, dung cp.cp_catalog_page_number

WEB_SITE (web):
- web.web_rec_end_date (dang hoat dong = IS NULL)
- web.web_rec_start_date (ngay bat dau)
- web.web_tax_percentage

SALES / ORDERS:
- store_sales: order number = ss.ss_ticket_number (KHONG co ss_order_number)
- web_sales: order number = ws.ws_order_number
- catalog_sales: order number = cs.cs_order_number
- "giam gia" -> *_ext_discount_amt
- "loi nhuan rong" -> *_net_profit
- "ton that rong tra hang" -> *_net_loss

DATE_DIM (d):
- Quarter: d.d_qoy (NOT d_quarter)
- Day name: d.d_day_name
- Weekend: d.d_weekend = 'Y'/'N'
- Khong co d_state -> dung ca_state (customer_address)

WEB_SALES (ws):
- Customer: ws.ws_bill_customer_sk (NOT ws_customer_sk)

STORE_SALES (ss):
- Tax: ss.ss_ext_tax (NOT ss_tax)
- Revenue: ss.ss_net_paid
- Demographics: ss.ss_cdemo_sk (direct link to customer_demographics)

=== REVENUE vs QUANTITY ===
- "ban chay nhat", "ban nhieu nhat" -> SUM(quantity)
- "doanh thu", "tong doanh thu" -> SUM(sales_price)
- "tien thu duoc", "net" -> SUM(net_paid)

=== CHANNEL RULES ===
- "cua hang", "store", "retail" -> store_sales (ss)
- "online", "web", "website", "truc tuyen" -> web_sales (ws)
- "catalog", "mail order" -> catalog_sales (cs)

=== RETURN RULES ===
- "tra lai hang" (khong ro channel) -> store_returns (sr) [MAC DINH]
- "tra hang online/web" -> web_returns (wr)
- "tra hang catalog" -> catalog_returns (cr)

=== DEMOGRAPHICS JOIN ===
- Khi can demographics tu store_sales: dung ss.ss_cdemo_sk truc tiep
  VD: JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk
- KHONG can di qua customer table neu chi can demographics

=== VALUE MAPPINGS ===
COUNTRY CODES (c_birth_country):
- "Viet Nam"/"Vietnam" -> 'VN'
- "Canada" -> 'CA'
- "My"/"United States" -> 'UNITED STATES'
- "USA" -> 'USA'
- "Vuong quoc Anh"/"UK"/"United Kingdom" -> 'UNITED KINGDOM'
- "Nhat Ban"/"Japan" -> 'JAPAN'

GENDER (cd_gender):
- Nam -> 'M', Nu -> 'F'

MARITAL STATUS (cd_marital_status):
- Doc than -> 'S', Ket hon -> 'M', Ly hon -> 'D', Goa -> 'W'

CREDIT RATING (cd_credit_rating):
- "thap" -> 'Low'
- "rui ro thap" -> 'Low Risk'
- "tot" -> 'Good'
- "uu tu"/"elite" -> 'Elite'
- "rui ro cao" -> 'High Risk'

PREFERRED CUSTOMER (c_preferred_cust_flag):
- "uu tien"/"than thiet"/"VIP" -> 'Y'
- "khong uu tien" -> 'N'

SALUTATION (c_salutation):
- "Mr" -> 'Mr.' ; "Ms" -> 'Ms.' ; "Mrs" -> 'Mrs.' ; "Dr" -> 'Dr.'

=== STATE / LOCATION ===
- Bang khach hang: JOIN customer -> customer_address, dung ca.ca_state
- Bang cua hang: JOIN store, dung s.s_state

=== CATEGORY FILTER ===
- Khi loc theo danh muc (Men, Women, Home, Shoes, ...): BAT BUOC JOIN item
- Dung: WHERE i.i_category = 'CategoryName'

=== QUERY PATTERNS ===
- "ty le don hang co khuyen mai" (khong noi channel) -> store_sales:
  SUM(CASE WHEN ss_promo_sk IS NOT NULL THEN 1 ELSE 0 END) / COUNT(*)
- "tre tuoi nhat" -> ORDER BY c_birth_year DESC, c_birth_month DESC, c_birth_day DESC
- "dang song/sinh song" -> dung customer_address (ca_country/ca_state), khong dung c_birth_country
- "quoc tich/sinh ra" -> dung c_birth_country
