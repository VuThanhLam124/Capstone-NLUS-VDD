=== QUY TẮC QUAN TRỌNG ===
1. KHÔNG thêm filter (WHERE) nếu câu hỏi KHÔNG yêu cầu (ví dụ: không thêm d.d_year nếu không hỏi về năm)
2. "bán chạy nhất" = SUM(quantity), KHÔNG phải SUM(sales_price)
3. "trả lại hàng" (không rõ kênh) -> mặc định dùng store_returns (sr)
4. "từ X trở lên" = >= X (ví dụ: "từ 2 xe trở lên" = hd_vehicle_count >= 2)
5. Chỉ SELECT các cột cần thiết, không thêm cột thừa
6. KHÔNG bịa cột/bảng không có trong schema
7. Luôn dùng alias cho bảng
8. Output ONLY the SQL query, no explanation.

=== ÁNH XẠ CỘT & BẢNG ===
CUSTOMER (c):
- c.c_salutation: danh xưng (Mr., Ms., Mrs., Dr.)
- c.c_birth_day / c.c_birth_month / c.c_birth_year: ngày/tháng/năm sinh (KHÔNG join date_dim)
- c.c_birth_country: quốc gia sinh / quốc tịch
- c.c_preferred_cust_flag: khách hàng ưu tiên (Y/N)
- c.c_login, c.c_email_address

CUSTOMER_DEMOGRAPHICS (cd):
- cd.cd_gender, cd.cd_marital_status, cd.cd_credit_rating
- cd.cd_education_status, cd.cd_dep_count, cd.cd_dep_college_count

HOUSEHOLD_DEMOGRAPHICS (hd):
- hd.hd_vehicle_count, hd.hd_dep_count, hd.hd_income_band_sk

CUSTOMER_ADDRESS (ca):
- ca.ca_state, ca.ca_city, ca.ca_country (địa chỉ hiện tại)

ITEM (i):
- "tên sản phẩm" -> i.i_product_name
- "mô tả sản phẩm" -> i.i_item_desc
- "giá niêm yết / giá hiện tại" -> i.i_current_price (KHÔNG có i_list_price)
- Danh mục lớn -> i.i_category, Loại cụ thể -> i.i_class
- "váy" -> i.i_class = 'dresses'
- "áo sơ mi" -> i.i_class = 'shirts'
- "áo kiểu" -> i.i_class = 'blouses'
- "quần" -> i.i_class = 'pants'
- "quần jeans" -> i.i_class = 'jeans'

CATALOG PAGE:
- "trang số X trong catalog" -> JOIN catalog_page cp, dùng cp.cp_catalog_page_number

WEB_SITE (web):
- web.web_rec_end_date (đang hoạt động = IS NULL)
- web.web_rec_start_date (ngày bắt đầu)
- web.web_tax_percentage

SALES / ORDERS:
- store_sales: order number = ss.ss_ticket_number (KHÔNG có ss_order_number)
- web_sales: order number = ws.ws_order_number
- catalog_sales: order number = cs.cs_order_number
- "giảm giá" -> *_ext_discount_amt
- "lợi nhuận ròng" -> *_net_profit
- "tổn thất ròng trả hàng" -> *_net_loss

DATE_DIM (d):
- Quarter: d.d_qoy (NOT d_quarter)
- Day name: d.d_day_name
- Weekend: d.d_weekend = 'Y'/'N'
- Không có d_state -> dùng ca_state (customer_address)

WEB_SALES (ws):
- Customer: ws.ws_bill_customer_sk (NOT ws_customer_sk)

STORE_SALES (ss):
- Tax: ss.ss_ext_tax (NOT ss_tax)
- Revenue: ss.ss_net_paid
- Demographics: ss.ss_cdemo_sk (direct link to customer_demographics)

=== DOANH THU VS SỐ LƯỢNG ===
- "bán chạy nhất", "bán nhiều nhất" -> SUM(quantity)
- "doanh thu", "tổng doanh thu" -> SUM(net_paid) [KHÔNG PHẢI sales_price]
  + web_sales: ws.ws_net_paid
  + store_sales: ss.ss_net_paid  
  + catalog_sales: cs.cs_net_paid
- "tiền thu được", "net" -> SUM(net_paid)

=== QUY TẮC KÊNH ===
- "cửa hàng", "store", "retail" -> store_sales (ss)
- "online", "web", "website", "trực tuyến" -> web_sales (ws)
- "catalog", "mail order" -> catalog_sales (cs)
- "tỷ lệ đơn hàng có khuyến mãi" (không nói kênh) -> store_sales [MẶC ĐỊNH]

=== QUY TẮC TRẢ HÀNG ===
- "trả lại hàng" (không rõ kênh) -> store_returns (sr) [MẶC ĐỊNH]
- "trả hàng online/web" -> web_returns (wr)
- "trả hàng catalog" -> catalog_returns (cr)

=== DEMOGRAPHICS JOIN ===
- Khi cần demographics từ store_sales: dùng ss.ss_cdemo_sk trực tiếp
  Ví dụ: JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk
- KHÔNG cần đi qua customer table nếu chỉ cần demographics

=== ÁNH XẠ GIÁ TRỊ ===
COUNTRY CODES (c_birth_country):
- "Việt Nam"/"Vietnam" -> 'VN'
- "Canada" -> 'CA'
- "Mỹ"/"United States" -> 'UNITED STATES'
- "USA" -> 'USA'
- "Vương quốc Anh"/"UK"/"United Kingdom" -> 'UNITED KINGDOM'
- "Nhật Bản"/"Japan" -> 'JAPAN'

GENDER (cd_gender):
- Nam -> 'M', Nữ -> 'F'

MARITAL STATUS (cd_marital_status):
- Độc thân -> 'S', Kết hôn -> 'M', Ly hôn -> 'D', Góa -> 'W'

CREDIT RATING (cd_credit_rating):
- "thấp" -> 'Low'
- "rủi ro thấp" -> 'Low Risk'
- "tốt" -> 'Good'
- "ưu tú"/"elite" -> 'Elite'
- "rủi ro cao" -> 'High Risk'

PREFERRED CUSTOMER (c_preferred_cust_flag):
- "ưu tiên"/"thân thiết"/"VIP" -> 'Y'
- "không ưu tiên" -> 'N'

SALUTATION (c_salutation):
- "Mr" -> 'Mr.' ; "Ms" -> 'Ms.' ; "Mrs" -> 'Mrs.' ; "Dr"/"Tiến sĩ" (danh xưng) -> 'Dr.'
- LƯU Ý: "Tiến sĩ PhD" (học vấn) -> cd_education_status = 'PhD'

=== VỊ TRÍ / ĐỊA ĐIỂM ===
- Bang khách hàng: JOIN customer -> customer_address, dùng ca.ca_state
- Bang cửa hàng: dùng s.s_state trực tiếp (KHÔNG join customer_address)
- "quốc gia sinh"/"quốc tịch" -> c.c_birth_country
- "đang sống"/"sinh sống" -> ca.ca_country (customer_address)

=== LỌC THEO DANH MỤC ===
- Khi lọc theo danh mục (Men, Women, Home, Shoes, ...): BẮT BUỘC JOIN item
- Dùng: WHERE i.i_category = 'CategoryName'

=== MẪU TRUY VẤN ===
- "tỷ lệ đơn hàng có khuyến mãi" (không nói kênh) -> store_sales:
  CAST(SUM(CASE WHEN ss_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS FLOAT) / COUNT(*)
- "trẻ tuổi nhất" -> ORDER BY c_birth_year DESC, c_birth_month DESC, c_birth_day DESC
- "giảm giá" -> ss.ss_ext_discount_amt (KHÔNG dùng promotion.p_discount_amt)

=== CỘT KHÔNG TỒN TẠI - TUYỆT ĐỐI KHÔNG DÙNG ===
- customer_address: KHÔNG có ca_birth_country, ca_last_name, ca_birth_month
- customer: KHÔNG có c_birth_date_sk (dùng c_birth_year/month/day)
- store: KHÔNG có s_addr_sk (dùng s_state trực tiếp)
- item: KHÔNG có i_list_price (dùng i_current_price)
- store_sales: KHÔNG có ss_order_number (dùng ss_ticket_number)
- promotion: KHÔNG có p_discount_amt (dùng ss_ext_discount_amt)
- category: BẢNG NÀY KHÔNG TỒN TẠI (dùng i.i_category)

